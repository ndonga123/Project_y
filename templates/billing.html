{% extends 'layout.html' %}{% block content %}<div class="d-flex justify-content-between"><h4>Billing</h4><button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addBill">Add Bill</button></div><table class="table mt-3"><thead><tr><th>#</th><th>Patient</th><th>Amount</th><th>Method</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>{% for b in bills %}<tr><td>{{ b.id }}</td><td>{{ b.patient.name }}</td><td>{{ b.amount }}</td><td>{{ b.payment_method or '-' }}</td><td>{{ b.status }}</td><td>{{ b.date_issued }}</td><td>{% if b.status!='Paid' %}<button class="btn btn-primary btn-sm" onclick="openPay({{ b.id }}, '{{ b.patient.name }}', {{ b.amount }})">Pay</button>{% else %}<span class="badge bg-success">Paid</span>{% endif %}<form method="post" action="{{ url_for('delete_bill', id=b.id) }}" style="display:inline;"><button class="btn btn-danger btn-sm">Delete</button></form></td></tr>{% endfor %}</tbody></table><!-- add bill modal --><div class="modal fade" id="addBill"><div class="modal-dialog"><div class="modal-content"><form method="post" action="{{ url_for('add_bill') }}"><div class="modal-header"><h5>Add Bill</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><select name="patient_id" class="form-select mb-2" required><option value=''>Select patient</option>{% for p in patients %}<option value='{{ p.id }}'>{{ p.name }}</option>{% endfor %}</select><input name='amount' class='form-control mb-2' placeholder='Amount' required type='number' step='0.01'><select name='payment_method' class='form-select mb-2'><option>Cash</option><option>M-Pesa</option><option>Insurance</option><option>ATM</option></select><input name='description' class='form-control' placeholder='Description'></div><div class='modal-footer'><button class='btn btn-secondary' data-bs-dismiss='modal'>Cancel</button><button class='btn btn-primary' type='submit'>Create</button></div></form></div></div></div><script>function openPay(id,name,amount){document.getElementById('payModalTitle').innerText='Pay '+name+' - Ksh '+amount;document.getElementById('payBillId').value=id;new bootstrap.Modal(document.getElementById('payModal')).show();}</script><div class="modal fade" id="payModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 id="payModalTitle"></h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input id="payBillId" type="hidden"><input id="payPhone" class="form-control" placeholder="2547..."></div><div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" onclick="startPay()">Pay</button></div></div></div></div><script>function startPay(){const id=document.getElementById('payBillId').value;const phone=document.getElementById('payPhone').value;fetch('/pay/simulate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bill_id:id,phone:phone,method:'M-Pesa'})}).then(r=>r.json()).then(res=>{if(res.status==='ok'){alert('Paid '+res.txn);location.reload();}else alert('Error');});}</script>{% endblock %}